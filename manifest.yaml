type: install
jpsVersion: 8.3.1
id: dbbench
name: DB Benchmarking
baseUrl: https://raw.githubusercontent.com/reclaimhosting/dbbench-jps/main
  
skipNodeEmails: true

nodes:
  nodeType: mysql
  nodeGroup: sqldb
  cloudlets: 32
  fixedcloudlets: 1
  extip: false

globals:
  DB_USER: user-${fn.random}
  DB_PASS: ${fn.password(10)}

onInstall:
  - setup

actions:
  
  setup:
    cmd[sqldb]: |-
      MYSQL_PWD=${nodes.sqldb.password} mysql -uroot -e "CREATE DATABASE dbbench;"
      MYSQL_PWD=${nodes.sqldb.password} mysql -uroot -e "CREATE USER '${globals.DB_USER}'@'%' IDENTIFIED BY '${globals.DB_PASS}';"
      MYSQL_PWD=${nodes.sqldb.password} mysql -uroot -e "GRANT ALL PRIVILEGES ON dbbench.* TO '${globals.DB_USER}'@'%' WITH GRANT OPTION;"
      curl ${baseUrl}/dbbench.sh -o /home/jelastic/dbbench.sh
      chmod +x /home/jelastic/dbbench.sh
      sed -i "s/##DB_USER##/${globals.DB_USER}/g" /home/jelastic/dbbench.sh
      sed -i "s/##DB_PASS##/${globals.DB_PASS}/g" /home/jelastic/dbbench.sh
